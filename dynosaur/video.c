#include <stdio.h>
#include <stdlib.h>
#include <SDL2/SDL.h>
#include "types.h"
#include "logging.h"
#include "config.h"

struct {
    SDL_Window      *window;
    SDL_Renderer    *renderer;
    SDL_Texture     *texture;
    Uint16          *pixels;
    BYTE            vdp_ram[24][40];
    Uint32          timer;
    char            *title;
    int             width;
    int             height;
} video;

BYTE charset[][8] = {
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00 }, // sp 04b0
    { 0x00, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x10 }, // !
    { 0x00, 0x28, 0x28, 0x28, 0x00, 0x00, 0x00, 0x00 }, // "
    { 0x00, 0x28, 0x28, 0x7c, 0x28, 0x7c, 0x28, 0x28 }, // #
    { 0x00, 0x38, 0x54, 0x50, 0x38, 0x14, 0x54, 0x38 }, // $
    { 0x00, 0x60, 0x64, 0x08, 0x10, 0x20, 0x4c, 0x0c }, // %
    { 0x00, 0x20, 0x50, 0x50, 0x20, 0x54, 0x48, 0x34 }, // &
    { 0x00, 0x08, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00 }, // '

    { 0x00, 0x08, 0x10, 0x20, 0x20, 0x20, 0x10, 0x08 }, // ( 06e8
    { 0x00, 0x20, 0x10, 0x08, 0x08, 0x08, 0x10, 0x20 }, // )
    { 0x00, 0x00, 0x28, 0x10, 0x7c, 0x10, 0x28, 0x00 }, // *
    { 0x00, 0x00, 0x10, 0x10, 0x7c, 0x10, 0x10, 0x00 }, // +
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x10, 0x20 }, // ,
    { 0x00, 0x00, 0x00, 0x00, 0x7c, 0x00, 0x00, 0x00 }, // -
    { 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30 }, // .
    { 0x00, 0x00, 0x04, 0x08, 0x10, 0x20, 0x40, 0x00 }, // /

    { 0x00, 0x38, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38 }, // 0 0720
    { 0x00, 0x10, 0x30, 0x10, 0x10, 0x10, 0x10, 0x38 }, // 1
    { 0x00, 0x38, 0x44, 0x04, 0x08, 0x10, 0x20, 0x7c }, // 2
    { 0x00, 0x38, 0x44, 0x04, 0x18, 0x04, 0x44, 0x38 }, // 3
    { 0x00, 0x08, 0x18, 0x28, 0x48, 0x7c, 0x08, 0x08 }, // 4
    { 0x00, 0x7c, 0x40, 0x78, 0x04, 0x04, 0x44, 0x38 }, // 5
    { 0x00, 0x18, 0x20, 0x40, 0x78, 0x44, 0x44, 0x38 }, // 6
    { 0x00, 0x7c, 0x04, 0x08, 0x10, 0x20, 0x20, 0x20 }, // 7

    { 0x00, 0x38, 0x44, 0x44, 0x38, 0x44, 0x44, 0x38 }, // 8 0758
    { 0x00, 0x38, 0x44, 0x44, 0x3c, 0x04, 0x08, 0x30 }, // 9
    { 0x00, 0x00, 0x30, 0x30, 0x00, 0x30, 0x30, 0x00 }, // :
    { 0x00, 0x00, 0x30, 0x30, 0x00, 0x30, 0x10, 0x20 }, // ;
    { 0x00, 0x08, 0x10, 0x20, 0x40, 0x20, 0x10, 0x08 }, // <
    { 0x00, 0x00, 0x00, 0x7c, 0x00, 0x7c, 0x00, 0x00 }, // =
    { 0x00, 0x20, 0x10, 0x08, 0x04, 0x08, 0x10, 0x20 }, // >
    { 0x00, 0x38, 0x44, 0x04, 0x08, 0x10, 0x00, 0x10 }, // ?

    { 0x00, 0x38, 0x44, 0x5c, 0x54, 0x5c, 0x40, 0x38 }, // @ 0790 
    { 0x00, 0x38, 0x44, 0x44, 0x7c, 0x44, 0x44, 0x44 }, // A
    { 0x00, 0x78, 0x44, 0x44, 0x78, 0x44, 0x44, 0x78 }, // B
    { 0x00, 0x38, 0x44, 0x40, 0x40, 0x40, 0x44, 0x38 }, // C
    { 0x00, 0x78, 0x44, 0x44, 0x44, 0x44, 0x44, 0x78 }, // D
    { 0x00, 0x7c, 0x40, 0x40, 0x78, 0x40, 0x40, 0x7c }, // E
    { 0x00, 0x7c, 0x40, 0x40, 0x78, 0x40, 0x40, 0x40 }, // F
    { 0x00, 0x38, 0x44, 0x40, 0x40, 0x4c, 0x44, 0x38 }, // G

    { 0x00, 0x44, 0x44, 0x44, 0x7c, 0x44, 0x44, 0x44 }, // H 07c8
    { 0x00, 0x38, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38 }, // I 
    { 0x00, 0x38, 0x08, 0x08, 0x08, 0x08, 0x48, 0x30 }, // J
    { 0x00, 0x44, 0x48, 0x50, 0x60, 0x50, 0x48, 0x44 }, // K
    { 0x00, 0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7c }, // L
    { 0x00, 0x44, 0x6c, 0x54, 0x44, 0x44, 0x44, 0x44 }, // M
    { 0x00, 0x44, 0x64, 0x54, 0x4c, 0x44, 0x44, 0x44 }, // N
    { 0x00, 0x7c, 0x44, 0x44, 0x44, 0x44, 0x44, 0x7c }, // O

    { 0x00, 0x78, 0x44, 0x44, 0x78, 0x40, 0x40, 0x40 }, // P 0800
    { 0x00, 0x38, 0x44, 0x44, 0x44, 0x54, 0x48, 0x34 }, // Q
    { 0x00, 0x78, 0x44, 0x44, 0x78, 0x50, 0x48, 0x44 }, // R
    { 0x00, 0x38, 0x44, 0x40, 0x38, 0x04, 0x44, 0x38 }, // S 
    { 0x00, 0x7c, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10 }, // T
    { 0x00, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38 }, // U
    { 0x00, 0x44, 0x44, 0x44, 0x28, 0x28, 0x10, 0x10 }, // V
    { 0x00, 0x44, 0x44, 0x44, 0x54, 0x54, 0x54, 0x28 }, // W

    { 0x00, 0x44, 0x44, 0x28, 0x10, 0x28, 0x44, 0x44 }, // X 0838
    { 0x00, 0x44, 0x44, 0x28, 0x10, 0x10, 0x10, 0x10 }, // Y
    { 0x00, 0x7c, 0x04, 0x08, 0x10, 0x20, 0x40, 0x7c }, // Z
};

const size_t charset_size = sizeof(charset) / 8;

void draw_char(int row, int col, BYTE char_no)
{
    int i, j;
    BYTE pattern;
    row *= 8;
    col *= 8;
    for (i = 0; i < 8; i++) {
        pattern = charset[char_no][i];
        for (j = 0; j < 8; j++) {
            video.pixels[((row + i) * 320) + (j + col)] = (pattern & 0x80) ? 65535 : 0;
            pattern <<= 1;
        }
    }

}

void refresh_video()
{
    int pitch;
    Uint32 current_timer = SDL_GetTicks();

    if ((current_timer - video.timer) < 34)
        return;

    video.timer = current_timer;

    if (SDL_LockTexture(video.texture, NULL, (void *) &video.pixels, &pitch))
        LOG_ERR("Error locking SDL texture: %s", SDL_GetError());

    memset(video.pixels, 0, 192 * pitch);

    int i, j, ch;
    for (i = 0; i < 24; i++)
        for (j = 0; j < 40; j++) {
            ch = video.vdp_ram[i][j];
            if (ch >= ' ' && ch <= 'Z')
                draw_char(i, j, ch - ' ');
        }

    SDL_UnlockTexture(video.texture);

    SDL_RenderCopy(video.renderer, video.texture, NULL, NULL);
    SDL_RenderPresent(video.renderer);

}

static void load_config()
{
    char buf[256];
    char *tmp;

    tmp = get_config_string("VIDEO", "SCREEN_SIZE");
    if (NULL != tmp) {
        tmp = split_string(tmp, buf, 'x');
        video.width = string_to_int(buf);
        video.height = string_to_int(tmp);
    } else {
        LOG_WRN("SCREEN_SIZE not found.  Setting to default.\n");
    }
    LOG_INF("Screen size = %dx%d.\n", video.width, video.height);

    video.title = get_config_string("VIDEO", "TITLE");
    if (NULL == video.title) {
        LOG_WRN("TITLE not found.  Setting to default.\n");
        video.title = "";
    }
    LOG_INF("Title = \"%s\".\n", video.title);
}

BYTE *init_video()
{
    LOG_INF("Initilizing video.\n");
    load_config();
    
    if (SDL_Init(SDL_INIT_VIDEO) < 0) {
        LOG_ERR("Error initializing SDL: %s", SDL_GetError());
        return 0;
    }

    video.window = SDL_CreateWindow(video.title, SDL_WINDOWPOS_UNDEFINED,
        SDL_WINDOWPOS_UNDEFINED, video.width, video.height, SDL_WINDOW_SHOWN);
    if (video.window == NULL) {
        LOG_ERR("Error creating SDL window: %s", SDL_GetError());
        return 0;
    }

    SDL_RaiseWindow(video.window);
    video.renderer = SDL_CreateRenderer(video.window, -1, 
        SDL_RENDERER_ACCELERATED | SDL_RENDERER_TARGETTEXTURE);
    if (video.window == NULL) {
        LOG_ERR("Error creating SDL renderer: %s", SDL_GetError());
        return 0;
    }

    SDL_SetRenderDrawColor(video.renderer, 0, 0, 0, 0);
    SDL_RenderClear(video.renderer);
    SDL_RenderPresent(video.renderer);

    video.texture = SDL_CreateTexture(video.renderer, 
        SDL_PIXELFORMAT_RGBA4444, SDL_TEXTUREACCESS_STREAMING, 320, 192);

    if (video.texture == NULL) { 
        LOG_ERR("Error creating SDL texture: %s", SDL_GetError());
        return 0;
    }

    refresh_video();

    return video.vdp_ram;
}

void finalize_video()
{
    LOG_INF("Finalizing video.\n");

    SDL_DestroyWindow(video.window);
    SDL_Quit();
}
